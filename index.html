<!DOCTYPE html>
<html lang="en">
<head>
<meta name=viewport content="width=device-width, initial-scale=1">
<script async src="js/zingchart.min.js"></script>
<style>
	body {font-size:75%;color:#222;background:#fff;font-family:"Helvetica Neue", Arial, Helvetica, sans-serif;}
	section {
	    height: 100px;
	    margin: auto;
	    padding: 10px;
	    border:1px solid black;
	}
	div#headings {
	    width: 60%;
	    height: 100%;
	    float: left;
	}
	div#controls {
	    float:left;
	    height: 100%;
	    width:20%;
	}
	div#controlscontrol {
		float:left;
		height: 100%;
		width:20%;
	}
	select {
		margin: 5px;
	}
	button {
		margin: 5px;
		width: 80%;
	}
</style>

<title>Wipy Log Viewer</title>
</head>

<body>
<h1>WiPy Log Viewer</h1>

<section id="dropTarget" ondrop="drop(event)" ondragover="allowDrop(event)">
<div id='headings'>
	<div >
		
		Select a text file or just drop one here: 
		<input type="file" id="fileInput">
		
	</div>
	<h2 id='CaptureDate'></h2>		
</div>
<div id='controls'>
	<select class='seriesSelect' id='s1'></select>
	<select class='seriesSelect' id='s2'></select>
	<select class='seriesSelect' id='s3'></select>
</div>
<div id='controlscontrol'>
	<button id="addSeriesBtn" onclick="addSeries()">Add Data Line</button>
	<br />
	<button id="removeSeriesBtn" onclick="removeSeries()">Remove Data Line</button>
</div>
</section>
	<div id ='chartDiv'></div>

</body>

<script type="text/javascript">

function allowDrop(ev) {
    ev.preventDefault();
}

function drag(ev) {
    ev.dataTransfer.setData("text", ev.target.id);
}

function drop(ev) {
    ev.preventDefault();

	var dt    = ev.dataTransfer;
  	var files = dt.files;
   	loadFile(files[0])
}
var headerMap={
	'Time' : 'Time',
	'28ffeb73531502f2':'Rad Out',
	'28ffcf7572150223':'Rad In'
}
function numSeries() {
	return document.querySelectorAll('.seriesSelect').length
}

function addSeries() {
	if(numSeries() < 5) {
		var controls=document.getElementById('controls')
		var select=document.createElement('select')
		select.className='seriesSelect';
		select.addEventListener('change',resetChart)
		setOptions(select,ui["dataSeries"]["headers"])
		controls.appendChild(select)
		resetChart()

	}
}
function removeSeries() {
	if(numSeries() > 2) {
		var selectors=document.querySelectorAll('.seriesSelect');
		var toDie=selectors[selectors.length-1]
		toDie.parentNode.removeChild(toDie)		
		resetChart()
	}
}
function loadFile(file){
	ui={}
	var reader = new FileReader();
	reader.onload = function(e) {
		processData(reader.result);
		setupSelectors()
		setOptionDefaults("Rad In","Rad Out","HighPoint")
		resetChart()
	}
	reader.readAsText(file);	

}
window.onload = function() {
		var fileInput = document.getElementById('fileInput');
		var fileDisplayArea = document.getElementById('fileDisplayArea');

		fileInput.addEventListener('change', function(e) {
			var file = fileInput.files[0];
			loadFile(file);
		});
}
function setupSelectors() {
	var selects = document.querySelectorAll('.seriesSelect')
	for(var i=0;i<selects.length;i++){
		selects[i].addEventListener('change',resetChart)
		setOptions(selects[i],ui["dataSeries"]["headers"])
	}
}

function processData(data) {
	var lines = data.split('\n');
	setCaptureDate(lines[1])
	var dataSeries = createSeries(lines)

	ui["dataSeries"]=dataSeries
}


function setCaptureDate(dte) {
	var startDate = new Date(2000,0,1) //WiPy epoc

	var numSecs = dte.split(',')[0]
	startDate.setSeconds(startDate.getSeconds()+numSecs);
	document.getElementById('CaptureDate').innerText=startDate.toString()
}

function sanitizeValues(idx,current,old) {
	for(var i=0;i<current.length;i++) {
		var diff=Math.abs(current[i]-old[i]);
		if(diff>10000) {
			console.log("idx "+idx+" current "+current[i]+" old "+old[i])
			current[i]=old[i];
		}
	}
}

function createSeries(data) {
	var series= {};
	var headers=data[0].split(',')
	for(var i=0;i<headers.length;i++) {
		headers[i]=headerMap[headers[i]]
	}
	for(var i = 0;i<headers.length;i++) {
		series[headers[i]]=[];
	}
	var oldValues=data[1].split(',')
	for (var i = 1 ; i < data.length;i++) {

		var values=data[i].split(',')

		sanitizeValues(i,values,oldValues)
		for (var j=0;j<values.length;j++) {
			series[headers[j]].push(Number(values[j]))
		}
		oldValues=values;
	}
	series["headers"]=headers
	return series
}

function setOptions(select,list) {
	while (select.options.length > 0) {
        select.remove(select.options.length - 1);
    }
    for(var i=0;i<list.length;i++) {
    	var opt = document.createElement('option');

        opt.text = list[i];
        opt.value = list[i];

        select.add(opt, null);
    }
}
function setOptionDefaults() {
	var selects = document.querySelectorAll('.seriesSelect')
	for(var i=0; i< selects.length && i < arguments.length;i++) {
		selects[i].value = arguments[i]
	}
}

function resetChart(e){
	var dataSeries=ui["dataSeries"]
	var xaxis=dataSeries["Time"]

	var selects = document.querySelectorAll('.seriesSelect')
	var numSelects=selects.length
	var series=[]
	for(var i=0;i<numSelects;i++){
		var serial={}
		serial["values"]=dataSeries[selects[i].value]
		serial["text"]=selects[i].value
		series.push(serial)
	}

	var chartData={
	 	"crosshair-x":{},
	    "type":"line",  
	    "series":series,
	    "scroll-x":{},
		"scale-x":{"labels":xaxis,"zooming":true}
	};
	for(var i=0;i<numSelects;i++){
		chartData[name]={"label":{"text":selects[i].value}}
	
	}
	showChart(chartData)
}
function showChart(chartData) {
	zingchart.render({ 
	    id:'chartDiv',
	    data:chartData,
	    height:"100%",
	    width:"100%"
	});
}


</script>
















</html>
